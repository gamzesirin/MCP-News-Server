<!DOCTYPE html>
<html lang="tr">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MCP Haber Sistemi</title>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<div class="container">
			<header class="header">
				<h1>MCP Haber Sistemi</h1>
				<p>Model Context Protocol ile Haber Analizi</p>
			</header>

			<!-- Tabs -->
			<div class="tabs">
				<button class="tab active" onclick="switchTab('news')">Haberler</button>
				<button class="tab" onclick="switchTab('favorites')">Favoriler <span class="fav-count" id="favCount">0</span></button>
			</div>

			<div class="main-grid">
				<section class="card" id="newsCard">
					<h2>Haberler</h2>
					<div class="filter-controls">
						<input type="text" id="searchKeyword" placeholder="Anahtar kelime..." onkeypress="if(event.key==='Enter')fetchNews()" />
						<button class="btn" onclick="fetchNews()">Ara</button>
					</div>
					<div class="filter-row">
						<select id="categoryFilter" onchange="fetchNews()">
							<option value="">Tüm Kategoriler</option>
							<option value="genel">Genel</option>
							<option value="teknoloji">Teknoloji</option>
							<option value="ekonomi">Ekonomi</option>
							<option value="spor">Spor</option>
							<option value="sağlık">Sağlık</option>
							<option value="bilim">Bilim</option>
							<option value="dünya">Dünya</option>
						</select>
						<select id="sourceFilter" onchange="fetchNews()">
							<option value="">Tüm Kaynaklar</option>
						</select>
					</div>
					<div class="loading" id="newsLoading">
						<div class="spinner"></div>
						<p>Yükleniyor...</p>
					</div>
					<div class="news-list" id="newsList"></div>
				</section>

				<!-- Favoriler Card (gizli başlar) -->
				<section class="card hidden" id="favoritesCard">
					<h2>Favori Haberler</h2>
					<div class="news-list" id="favoritesList"></div>
				</section>

				<section class="card">
					<h2>Metin Özetleme</h2>
					<textarea id="textToSummarize" placeholder="Özetlenecek metni girin veya bir habere tıklayın..."></textarea>
					<button class="btn" onclick="summarizeText()">Özetle</button>
					<div class="loading" id="summaryLoading">
						<div class="spinner"></div>
						<p>Özetleniyor...</p>
					</div>
					<div id="summaryResult"></div>
				</section>
			</div>

			<section class="card">
				<h2>Trend Analizi</h2>
				<button class="btn" onclick="analyzeTrends()">Analiz Et</button>
				<div class="loading" id="trendsLoading">
					<div class="spinner"></div>
					<p>Analiz ediliyor...</p>
				</div>
				<div id="trendsResult"></div>
			</section>

			<!-- Duygu Analizi Bölümü -->
			<section class="card">
				<h2>Duygu Analizi</h2>
				<div class="analysis-grid">
					<div class="analysis-section">
						<h3>Metin Analizi</h3>
						<textarea id="sentimentText" placeholder="Duygu analizi yapılacak metni girin..."></textarea>
						<button class="btn" onclick="analyzeSentiment()">Analiz Et</button>
						<div class="loading" id="sentimentLoading">
							<div class="spinner"></div>
							<p>Analiz ediliyor...</p>
						</div>
						<div id="sentimentResult"></div>
					</div>
					<div class="analysis-section">
						<h3>Haberlerin Duygu Analizi</h3>
						<div class="filter-row">
							<select id="sentimentCategory">
								<option value="">Tüm Kategoriler</option>
								<option value="genel">Genel</option>
								<option value="teknoloji">Teknoloji</option>
								<option value="ekonomi">Ekonomi</option>
								<option value="spor">Spor</option>
								<option value="dünya">Dünya</option>
							</select>
							<input type="number" id="sentimentLimit" value="10" min="1" max="50" style="width:80px" />
							<button class="btn" onclick="analyzeNewsSentiment()">Haberleri Analiz Et</button>
						</div>
						<div class="loading" id="newsSentimentLoading">
							<div class="spinner"></div>
							<p>Haberler analiz ediliyor...</p>
						</div>
						<div id="newsSentimentResult"></div>
					</div>
				</div>
			</section>

			<!-- Duplikasyon Araçları Bölümü -->
			<section class="card">
				<h2>Metin Benzerlik Kontrolü</h2>
				<div class="analysis-section">
					<div class="similarity-inputs">
						<textarea id="text1" placeholder="Birinci metin..."></textarea>
						<textarea id="text2" placeholder="İkinci metin..."></textarea>
					</div>
					<button class="btn" onclick="checkSimilarity()">Karşılaştır</button>
					<div class="loading" id="similarityLoading">
						<div class="spinner"></div>
						<p>Karşılaştırılıyor...</p>
					</div>
					<div id="similarityResult"></div>
				</div>
			</section>

			<footer class="footer">
				MCP News Server
			</footer>
		</div>

		<!-- Haber Detay Modal -->
		<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
			<div class="modal" onclick="event.stopPropagation()">
				<button class="modal-close" onclick="closeModal()">&times;</button>
				<div class="modal-content" id="modalContent"></div>
			</div>
		</div>

		<script>
			const API_URL = 'http://localhost:3000/api'
			const FAVORITES_KEY = 'mcp_news_favorites'
			let allSources = new Set()
			let newsCache = new Map() // Haberleri cache'le

			// Haber cache yönetimi
			function cacheNews(item) {
				newsCache.set(item.id, item)
			}

			function getNewsById(id) {
				return newsCache.get(id) || getFavorites().find(f => f.id === id)
			}

			// Favoriler yönetimi
			function getFavorites() {
				try {
					return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || []
				} catch { return [] }
			}

			function saveFavorites(favorites) {
				localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites))
				updateFavCount()
			}

			function isFavorite(id) {
				return getFavorites().some(f => f.id === id)
			}

			function toggleFavorite(id, event) {
				if (event) event.stopPropagation()
				const item = getNewsById(id)
				if (!item) return

				let favorites = getFavorites()

				if (isFavorite(id)) {
					favorites = favorites.filter(f => f.id !== id)
				} else {
					favorites.push(item)
				}

				saveFavorites(favorites)
				displayNews(Array.from(newsCache.values())) // Listeyi güncelle
				displayFavorites() // Favorileri güncelle

				// Modal açıksa içeriğini güncelle
				if (document.getElementById('modalOverlay').classList.contains('active')) {
					openModal(id)
				}
			}

			function updateFavCount() {
				document.getElementById('favCount').textContent = getFavorites().length
			}

			function displayFavorites() {
				const list = document.getElementById('favoritesList')
				const favorites = getFavorites()

				if (!favorites.length) {
					list.innerHTML = '<div class="empty-state">Henüz favori haber eklemediniz</div>'
					return
				}

				list.innerHTML = favorites.map(item => {
					cacheNews(item) // Favorileri de cache'e ekle
					return `
					<div class="news-item" onclick="openModal('${item.id}')">
						<div class="news-item-header">
							<h3>${esc(item.title)}</h3>
							<button class="fav-btn active" onclick="toggleFavorite('${item.id}', event)" title="Favorilerden çıkar">
								★
							</button>
						</div>
						<div class="meta">
							<span>${formatDate(item.pubDate)}</span>
							<span>${esc(item.source)}</span>
						</div>
					</div>
				`}).join('')
			}

			// Tab değiştirme
			function switchTab(tab) {
				document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
				event.target.classList.add('active')

				const newsCard = document.getElementById('newsCard')
				const favCard = document.getElementById('favoritesCard')

				if (tab === 'favorites') {
					newsCard.classList.add('hidden')
					favCard.classList.remove('hidden')
					displayFavorites()
				} else {
					newsCard.classList.remove('hidden')
					favCard.classList.add('hidden')
				}
			}

			// Kaynak filtresini güncelle
			function updateSourceFilter(news) {
				news.forEach(item => {
					if (item.source) allSources.add(item.source)
				})

				const select = document.getElementById('sourceFilter')
				const currentValue = select.value

				select.innerHTML = '<option value="">Tüm Kaynaklar</option>' +
					Array.from(allSources).sort().map(s =>
						`<option value="${esc(s)}" ${s === currentValue ? 'selected' : ''}>${esc(s)}</option>`
					).join('')
			}

			async function fetchNews() {
				const keyword = document.getElementById('searchKeyword').value
				const category = document.getElementById('categoryFilter').value
				const source = document.getElementById('sourceFilter').value
				const loading = document.getElementById('newsLoading')
				const newsList = document.getElementById('newsList')

				loading.classList.add('active')
				newsList.innerHTML = ''

				try {
					const params = new URLSearchParams({ limit: '20' })
					if (keyword) params.append('keyword', keyword)
					if (category) params.append('category', category)

					const response = await fetch(`${API_URL}/news?${params}`)
					const data = await response.json()

					if (data.success) {
						updateSourceFilter(data.data)
						let filtered = data.data
						if (source) {
							filtered = filtered.filter(item => item.source === source)
						}
						displayNews(filtered)
					} else {
						newsList.innerHTML = `<div class="error">${data.error}</div>`
					}
				} catch (error) {
					newsList.innerHTML = `<div class="error">Bağlantı hatası</div>`
				} finally {
					loading.classList.remove('active')
				}
			}

			function displayNews(news) {
				const newsList = document.getElementById('newsList')

				if (!news.length) {
					newsList.innerHTML = '<div class="empty-state">Haber bulunamadı</div>'
					return
				}

				newsList.innerHTML = news.map(item => {
					cacheNews(item) // Her haberi cache'e ekle
					return `
					<div class="news-item" onclick="openModal('${item.id}')">
						<div class="news-item-header">
							<h3>${esc(item.title)}</h3>
							<button class="fav-btn ${isFavorite(item.id) ? 'active' : ''}" onclick="toggleFavorite('${item.id}', event)" title="${isFavorite(item.id) ? 'Favorilerden çıkar' : 'Favorilere ekle'}">
								${isFavorite(item.id) ? '★' : '☆'}
							</button>
						</div>
						<div class="meta">
							<span>${formatDate(item.pubDate)}</span>
							<span>${esc(item.source)}</span>
						</div>
					</div>
				`}).join('')
			}

			// Modal fonksiyonları
			function openModal(id) {
				const item = getNewsById(id)
				if (!item) return

				const modal = document.getElementById('modalOverlay')
				const content = document.getElementById('modalContent')

				content.innerHTML = `
					<div class="modal-header">
						<h2>${esc(item.title)}</h2>
						<button class="fav-btn large ${isFavorite(item.id) ? 'active' : ''}" onclick="toggleFavorite('${item.id}', event)">
							${isFavorite(item.id) ? '★ Favorilerde' : '☆ Favorilere Ekle'}
						</button>
					</div>
					<div class="modal-meta">
						<span>${formatDate(item.pubDate)}</span>
						<span>${esc(item.source)}</span>
					</div>
					<div class="modal-body">
						<p>${esc(item.description || item.content || 'İçerik bulunamadı')}</p>
					</div>
					<div class="modal-actions">
						<a href="${item.link}" target="_blank" class="btn">Habere Git</a>
						<button class="btn btn-secondary" onclick="useForSummary('${item.id}')">Özetle</button>
					</div>
				`

				modal.classList.add('active')
				document.body.style.overflow = 'hidden'
			}

			function closeModal() {
				document.getElementById('modalOverlay').classList.remove('active')
				document.body.style.overflow = ''
			}

			function useForSummary(id) {
				const item = getNewsById(id)
				if (!item) return

				const ta = document.getElementById('textToSummarize')
				ta.value = `${item.title}\n\n${item.description || item.content || ''}`
				closeModal()

				const card = ta.closest('.card')
				if (card) {
					card.scrollIntoView({ behavior: 'smooth', block: 'start' })
				}
				setTimeout(() => ta.focus(), 300)
			}

			// ESC tuşu ile modal kapatma
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape') closeModal()
			})

			async function summarizeText() {
				const text = document.getElementById('textToSummarize').value
				const loading = document.getElementById('summaryLoading')
				const result = document.getElementById('summaryResult')

				if (!text.trim()) {
					result.innerHTML = '<div class="error">Metin girin</div>'
					return
				}

				loading.classList.add('active')
				result.innerHTML = ''

				try {
					const response = await fetch(`${API_URL}/summarize`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ text, sentenceCount: 3 })
					})
					const data = await response.json()

					if (data.success) {
						displaySummary(data.data)
					} else {
						result.innerHTML = `<div class="error">${data.error}</div>`
					}
				} catch (error) {
					result.innerHTML = '<div class="error">Bağlantı hatası</div>'
				} finally {
					loading.classList.remove('active')
				}
			}

			function displaySummary(data) {
				document.getElementById('summaryResult').innerHTML = `
					<div class="summary-result">
						<h4>Özet</h4>
						<p>${esc(data.summary)}</p>
						${data.keywords?.length ? `
							<h4 style="margin-top:12px">Anahtar Kelimeler</h4>
							<div class="keywords">${data.keywords.map(k => `<span class="keyword">${esc(k)}</span>`).join('')}</div>
						` : ''}
						<div class="stats">
							<div class="stat">
								<div class="stat-value">${data.sentenceCount}</div>
								<div class="stat-label">Cümle</div>
							</div>
							<div class="stat">
								<div class="stat-value">${data.reductionRatio.toFixed(0)}%</div>
								<div class="stat-label">Sıkıştırma</div>
							</div>
						</div>
					</div>
				`
			}

			async function analyzeTrends() {
				const loading = document.getElementById('trendsLoading')
				const result = document.getElementById('trendsResult')

				loading.classList.add('active')
				result.innerHTML = ''

				try {
					const response = await fetch(`${API_URL}/trends`)
					const data = await response.json()

					if (data.success) {
						displayTrends(data.data)
					} else {
						result.innerHTML = `<div class="error">${data.error}</div>`
					}
				} catch (error) {
					result.innerHTML = '<div class="error">Bağlantı hatası</div>'
				} finally {
					loading.classList.remove('active')
				}
			}

			function displayTrends(data) {
				document.getElementById('trendsResult').innerHTML = `
					<div class="stats">
						<div class="stat">
							<div class="stat-value">${data.newsCount}</div>
							<div class="stat-label">Haber</div>
						</div>
						<div class="stat">
							<div class="stat-value">${esc(data.period)}</div>
							<div class="stat-label">Dönem</div>
						</div>
					</div>
					${data.keywords?.length ? `
						<div style="margin-top:16px">
							<div class="keywords">${data.keywords.map(k => `<span class="keyword">${esc(k)}</span>`).join('')}</div>
						</div>
					` : ''}
					${data.latestNews?.length ? `
						<div style="margin-top:16px">
							${data.latestNews.map(n => `
								<div class="news-item" style="cursor:default">
									<h3>${esc(n.title)}</h3>
									<div class="meta">
										<span>${formatDate(n.date)}</span>
										<span>${esc(n.source)}</span>
									</div>
								</div>
							`).join('')}
						</div>
					` : ''}
				`
			}

			// ============ DUYGU ANALİZİ FONKSİYONLARI ============

			// Label çevirisi (API: positive/negative/neutral -> Türkçe)
			function translateLabel(label) {
				const translations = {
					'positive': 'pozitif',
					'negative': 'negatif',
					'neutral': 'nötr'
				}
				return translations[label] || label
			}

			async function analyzeSentiment() {
				const text = document.getElementById('sentimentText').value
				const loading = document.getElementById('sentimentLoading')
				const result = document.getElementById('sentimentResult')

				if (!text.trim()) {
					result.innerHTML = '<div class="error">Metin girin</div>'
					return
				}

				loading.classList.add('active')
				result.innerHTML = ''

				try {
					const response = await fetch(`${API_URL}/sentiment`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ text })
					})
					const data = await response.json()

					if (data.success) {
						displaySentimentResult(data.data, result)
					} else {
						result.innerHTML = `<div class="error">${data.error}</div>`
					}
				} catch (error) {
					result.innerHTML = '<div class="error">Bağlantı hatası</div>'
				} finally {
					loading.classList.remove('active')
				}
			}

			function displaySentimentResult(data, container) {
				const labelColors = {
					'positive': '#22c55e',
					'negative': '#ef4444',
					'neutral': '#6b7280'
				}
				const color = labelColors[data.label] || '#6b7280'
				const turkishLabel = translateLabel(data.label)

				// Score bar genişliği hesapla (0-1 arası normalize)
				const normalizedScore = Math.min(Math.abs(data.score) / 5, 1)

				container.innerHTML = `
					<div class="sentiment-result">
						<div class="sentiment-label" style="background: ${color}">${turkishLabel.toUpperCase()}</div>
						<div class="sentiment-score">
							<div class="score-bar">
								<div class="score-fill" style="width: ${normalizedScore * 100}%; background: ${color}"></div>
							</div>
							<span>Skor: ${data.score.toFixed(2)} | Güven: %${(data.confidence * 100).toFixed(0)}</span>
						</div>
						${(data.positiveWords && data.positiveWords.length) || (data.negativeWords && data.negativeWords.length) ? `
							<div class="sentiment-details">
								${data.positiveWords && data.positiveWords.length ? `<span class="detail positive">Pozitif: ${data.positiveWords.join(', ')}</span>` : ''}
								${data.negativeWords && data.negativeWords.length ? `<span class="detail negative">Negatif: ${data.negativeWords.join(', ')}</span>` : ''}
							</div>
						` : ''}
					</div>
				`
			}

			async function analyzeNewsSentiment() {
				const category = document.getElementById('sentimentCategory').value
				const limit = document.getElementById('sentimentLimit').value
				const loading = document.getElementById('newsSentimentLoading')
				const result = document.getElementById('newsSentimentResult')

				loading.classList.add('active')
				result.innerHTML = ''

				try {
					const params = new URLSearchParams({ limit })
					if (category) params.append('category', category)

					const response = await fetch(`${API_URL}/sentiment/news?${params}`)
					const data = await response.json()

					if (data.success) {
						displayNewsSentiment(data.data, result)
					} else {
						result.innerHTML = `<div class="error">${data.error}</div>`
					}
				} catch (error) {
					result.innerHTML = '<div class="error">Bağlantı hatası</div>'
				} finally {
					loading.classList.remove('active')
				}
			}

			function displayNewsSentiment(data, container) {
				const { summary, news } = data
				const total = summary.totalAnalyzed || 1

				// Türkçe label al
				const overallLabelTr = translateLabel(summary.overallLabel)

				container.innerHTML = `
					<div class="sentiment-summary">
						<h4>Genel Durum: <span class="sentiment-label-inline ${overallLabelTr}">${overallLabelTr.toUpperCase()}</span></h4>
						<div class="distribution-bar">
							<div class="dist-positive" style="width: ${(summary.distribution.positive / total) * 100}%">${summary.distribution.positive}</div>
							<div class="dist-neutral" style="width: ${(summary.distribution.neutral / total) * 100}%">${summary.distribution.neutral}</div>
							<div class="dist-negative" style="width: ${(summary.distribution.negative / total) * 100}%">${summary.distribution.negative}</div>
						</div>
						<div class="distribution-legend">
							<span class="legend-item"><span class="dot positive"></span> Pozitif</span>
							<span class="legend-item"><span class="dot neutral"></span> Nötr</span>
							<span class="legend-item"><span class="dot negative"></span> Negatif</span>
						</div>
					</div>
					<div class="news-sentiment-list">
						${news.map(n => {
							const labelTr = translateLabel(n.sentiment.label)
							return `
							<div class="news-sentiment-item">
								<div class="news-title">${esc(n.title)}</div>
								<div class="news-meta">
									<span>${esc(n.source)}</span>
									<span class="sentiment-badge ${labelTr}">${labelTr.toUpperCase()}</span>
								</div>
							</div>
						`}).join('')}
					</div>
				`
			}

			// ============ METİN BENZERLİK FONKSİYONU ============

			async function checkSimilarity() {
				const text1 = document.getElementById('text1').value
				const text2 = document.getElementById('text2').value
				const loading = document.getElementById('similarityLoading')
				const result = document.getElementById('similarityResult')

				if (!text1.trim() || !text2.trim()) {
					result.innerHTML = '<div class="error">Her iki metni de girin</div>'
					return
				}

				loading.classList.add('active')
				result.innerHTML = ''

				try {
					const response = await fetch(`${API_URL}/similarity`, {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ text1, text2 })
					})
					const data = await response.json()

					if (data.success) {
						const { similarity, isDuplicate } = data.data
						result.innerHTML = `
							<div class="similarity-result ${isDuplicate ? 'duplicate' : 'unique'}">
								<div class="similarity-score">${similarity}%</div>
								<div class="similarity-label">${isDuplicate ? 'Muhtemelen Aynı Haber' : 'Farklı Haberler'}</div>
								<div class="similarity-bar">
									<div class="bar-fill" style="width: ${similarity}%"></div>
								</div>
							</div>
						`
					} else {
						result.innerHTML = `<div class="error">${data.error}</div>`
					}
				} catch (error) {
					result.innerHTML = '<div class="error">Bağlantı hatası</div>'
				} finally {
					loading.classList.remove('active')
				}
			}

			function esc(t) {
				if (!t) return ''
				const d = document.createElement('div')
				d.textContent = t
				return d.innerHTML
			}

			function formatDate(d) {
				if (!d) return ''
				try {
					return new Date(d).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })
				} catch { return '' }
			}

			window.onload = () => {
				fetchNews()
				updateFavCount()
			}
		</script>
	</body>
</html>
